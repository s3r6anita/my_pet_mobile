name: Pull Request CI

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]
  # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
  workflow_dispatch:

# –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–±–æ—Ä–∫–∏ –≤ —Ç–æ–º –∂–µ PR, —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∞—Ç–∏—Ç—å –º–∏–Ω—É—Ç—ã
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º –∞–Ω–∞–ª–∏–∑–æ–º (Detekt)
  static_analysis:
    name: üîç Static Analysis (Detekt)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Detekt —Ç—Ä–µ–±—É–µ—Ç Java –¥–ª—è —Ä–∞–±–æ—Ç—ã
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: üêï Install reviewdog
        uses: reviewdog/action-setup@v1
        with:
          reviewdog_version: latest

      # –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏, –∫—É–¥–∞ —Å–∫—Ä–∏–ø—Ç –∫–∞—á–∞–µ—Ç detekt-cli
      - uses: actions/cache@v4
        name: Cache Detekt Binary
        with:
          path: build/bin
          key: ${{ runner.os }}-detekt-${{ hashFiles('detekt') }}

      - name: üíú Run Detekt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x detekt
          ./detekt

  # 2. –°–±–æ—Ä–∫–∞ –∏ Unit-—Ç–µ—Å—Ç—ã
  build_and_test:
    name: üî® Build & Test
    runs-on: ubuntu-latest
    needs: static_analysis # –û–∂–∏–¥–∞–Ω–∏–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è detekt

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # –≠—Ç–æ—Ç —ç–∫—à–µ–Ω —Å–∞–º –Ω–∞—Å—Ç—Ä–æ–∏—Ç –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –∫—ç—à Gradle, —á—Ç–æ —É—Å–∫–æ—Ä–∏—Ç —Å–±–æ—Ä–∫—É –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—É—Å–∫–∞—Ö
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # –í—ã–¥–∞—á–∞ –ø—Ä–∞–≤ –Ω–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ gradlew
      - name: üîê Grant execute permission for gradlew
        run: chmod +x gradlew

      # testDebugUnitTest - –ø—Ä–æ–≥–æ–Ω —Ç–µ—Å—Ç–æ–≤
      - name: üß™ Run Tests
        run: ./gradlew testDebugUnitTest

      # assembleDebug - —Å–±–æ—Ä–∫–∞ APK
      - name: üöÄ Build
        run: ./gradlew assembleDebug

      # –ó–∞–≥—Ä—É–∑–∫–∞ APK –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
      - name: üîÑ Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 7

      # –û—Ç—á–µ—Ç—ã –æ —Ç–µ—Å—Ç–∞—Ö
      - name: üìä Upload Test Reports
        if: failure() # –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: app/build/reports/tests/
